# -------------------------
# Stage 1 — Builder (Maven + JDK 17)
# -------------------------
FROM maven:3.9.4-eclipse-temurin-17 AS builder

WORKDIR /build

# copy only what's needed to download dependencies first (speeds rebuilds)
COPY pom.xml ./
COPY .mvn .mvn
COPY mvnw mvnw
RUN chmod +x mvnw || true

# download dependencies (offline step)
RUN mvn -B -DskipTests dependency:go-offline

# copy source and build
COPY src ./src
# Build the jar (skip tests by default for faster image build; remove -DskipTests for CI)
RUN mvn -B -DskipTests package

# -------------------------
# Stage 2 — Runtime (lighter JRE)
# -------------------------
FROM eclipse-temurin:17-jre-jammy

# create a non-root user for better security
RUN useradd -m -u 1000 appuser

WORKDIR /app

# install curl for healthchecks (small, removed lists afterwards)
RUN apt-get update \
 && apt-get install -y --no-install-recommends curl \
 && rm -rf /var/lib/apt/lists/*

# copy built jar from builder stage (pattern matches the built jar)
COPY --from=builder /build/target/*.jar app.jar

# expose the port your Spring Boot app listens on (you said production uses 8080)
EXPOSE 8080

# default JVM options you can override at runtime with -e JAVA_OPTS="..."
ENV JAVA_OPTS="-Xms256m -Xmx512m -Djava.security.egd=file:/dev/./urandom"

# switch to non-root user
USER appuser

# a simple healthcheck — adjust path if you use a different health endpoint
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD curl -fsS --max-time 2 http://127.0.0.1:8080/api/recipes/ping || exit 1

# start the app
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar"]
